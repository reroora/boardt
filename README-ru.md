# boardt

[![en](https://img.shields.io/badge/lang-en-yellow.svg)](./README.md)

Boardt (от англ. "board register debugging tool") программное обеспечение для проверки 
и изменения состояния регистров платы.

## Возможности

Данный инструмент предоставляет следующий функционал:

- Добавление плат с помощью конфигурационного файла.
- Коммуникация между платой и программой через COM-порт.
- Эмуляция платы.
- Кодек для собственного протокола коммуникации.

**Все возможности представленные выше находятся на стадии разработки.**

## Сборка

Собирать используя mingw-w64 14.2.0-3 и Qt 5.12.8 с помощью qmake в Qt Creator.

## Конфигурационный файл платы

Параметры платы устанавливаются с помощью json файла (пока что, захардкожено название "boards.json").

Пример конфигурации представлен ниже.

``` json
{
    "Boards": [
        {
            "BoardName": "MAX77958",
            "RegisterNameAddressPairs": [
                    {"DEVICE_ID": "0"},
                    {"DEVICE_REV": "1"},
                    {"FW_REV": "2"},
                    {"FW_SUB_VER": "3"},
                    {"UIC_INT": "4"}
            ],
            "RegisterAccessType" : [
                {"DEVICE_ID": "RO"},
                {"DEVICE_REV": "RO"},
                {"FW_REV": "RO"},
                {"FW_SUB_VER": "RO"},
                {"UIC_INT": [
                        {"AttachedHoldI" : "RCA"},
                        {"ChgTypI" : "RCA"},
                        {"StopModeI" : "RCA"},
                        {"DCDTmoI" : "RCA"},
                        {"VbADCI" : "RCA"},
                        {"VBUSDetI" : "RCA"},
                        {"SYSMsgI" : "RCA"},
                        {"APCmdResI" : "RCA"} ] }
            ]
        },
        {
            "BoardName": "TEST",
            "RegisterNameAddressPairs": [
                    {"inp": "0"},
                    {"outp": "1"}
            ]
        }
    ]
}
```

Объект json должен содержать массив с именем "Boards". Элемент массива должен содержать ключи BoardName" и "RegisterNameAddressPairs".
Ключ "BoardName" содержит имя платы с которой программа будет взаимодействовать. 
Ключ "RegisterNameAddressPairs" содержит массив пар "имя регистра" : "смещение регистра".
Также, конкретный элемент платы может содержать другие ключи которые могут быть использованы программистом (например ключ "RegisterAccessType", который пока не реализован).

## Протокол

Это прототип протокола для общения между платой и средством отладки.

Общение начинается с установки версии протокола через рукопожатие с предложением версий с обеих сторон.

После установки версии, обе стороны могут отправлять команды и быть уверены что они будут правильно интерпретироваться.

На данный момент протокол предоставляет некоторый набор команд.
Каждая команда начинается с кода команды. Коды команды представлены в таблице ниже.

| Команда            | Код  | 
| ------------------ | ---- |
| HandshakeCommand   | 0x01 |
| SetRegisterCommand | 0x02 |
| GetRegisterCommand | 0x03 |

И после кода команды, каждая команда хранит некоторую необходимую информацию.

#### HandshakeCommand 

Данная команда используется для установки версии и начала общения.

| Handshake number | Mode   | Size/version | Version1/version2 | version3/version4 | ... |
| ---------------- | ------ | ------------ | ----------------- | ----------------- | --- |
| 2 бита           | 2 бита |    4 бита    | 4 бита / 4 бита   |  4 бита / 4 бита   |     |

**Handshake number** - последовательный номер рукопожатия (можно назвать аналогом syn/ack) 
(0b00 - HandshakeStart, 0b01 - HandshakeResponse, 0b10 - HandshakeAccept)

**Mode** - это поле обозначает как следует интерпретировать последующие данные.
Значение **Single** (0b0) обозначает что отправлена только одна версия (версия должна быть установлена в поле size/version).
значение **Vector** (0b1) обозначает что следующие данные должны интерпретироваться как массив, 
установите размер массива в поле size/version и задайте массив как в таблице выше.
Значение **Range** (0b10) обозначает что следующие данные нужно интерпретировать как массив 
диапазонов из пар начало-конец, пары хранятся в одном байте (начало/конец = version1/version2 из таблицы выше).

**Size/version** - зависит от режима, может быть как размером, так и версией.

**Version1/version2**, **Version1/version2** ... - как и поле **size/version** зависит от **mode**.

#### SetRegisterCommand

Команда используется для установки значений регистров по смещению.

| Flags  | Sizes  | Register Offset | Register value  | 
| ------ | ------ | --------------- |---------------- |
| 1 байт | 1 байт |  байт - 8 байт  | байт - 64 байта |

**Flags** - флаги для команды. На данные момент предоставляет только одно поле: **mode** - 
аналог поля с таким же названием из **HandshakeCommand**. Сейчас поддерживается только режим **single**.

**Sizes** - размеры для следующих полей: 

- **offset size** - размер поля **register offset** (2 бита), кодирует размеры 8, 16, 32, 64; 2^(3 + value) бит.
- **register size** - размер поля **register value** (3 бита) кодирует размеры 4, 8, 16, 32, 64, 128, 256, 512; 2^(2 + value) бит.

**Register Offset** - смещение регистра. Длина поля зависит от поля **offset size**.

**Register value** - значение регистра. Длина поля зависит от поля  **register size**.

#### GetRegisterCommand

Команда используется для запросов получения значений регистров.

| Flags  | Sizes  | Register Offset |
| ------ | ------ | --------------- |
| 1 байт | 1 байт |  байт - 8 байт  | 

**Flags** - то же что и в **SetRegisterCommand**.

**Sizes** - то же что и в **SetRegisterCommand**, но без **register size**.

**Register Offset** - то же что и в **SetRegisterCommand**.
